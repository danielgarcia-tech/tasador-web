# ๐ Deployment en Vercel - Documentaciรณn Tรฉcnica

## Descripciรณn General

Tasador Web estรก configurada para despliegue automรกtico y continuo en Vercel. Este documento explica cรณmo funciona el sistema de deploy, cรณmo configurarlo, y cรณmo solucionar problemas.

## Flujo de Deploy Automรกtico

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. DESARROLLADOR HACE GIT COMMIT & PUSH                    โ
โ    $ git add .                                             โ
โ    $ git commit -m "Feature: nueva calculadora"            โ
โ    $ git push origin feature-branch                        โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 2. GITHUB RECIBE PUSH                                      โ
โ    โโ Actualiza repositorio                               โ
โ    โโ Ejecuta checks: eslint, typescript                   โ
โ    โโ Envia webhook a Vercel                              โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 3. VERCEL RECIBE WEBHOOK                                   โ
โ    โโ Detecta cambios en rama                              โ
โ    โโ Inicia nuevo build                                   โ
โ    โโ Asigna ID de deploy รบnico                           โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 4. BUILD PROCESS                                           โ
โ                                                            โ
โ    a) Instalar dependencias                                โ
โ       $ npm ci                                             โ
โ       โโ Instala versiones exactas de package-lock.json    โ
โ       โโ Verifica integridad                               โ
โ       โโ ~3 minutos                                        โ
โ                                                            โ
โ    b) TypeScript compilation                               โ
โ       $ tsc -b                                             โ
โ       โโ Verifica tipos                                    โ
โ       โโ Genera errores si hay incompatibilidades          โ
โ       โโ ~30 segundos                                      โ
โ                                                            โ
โ    c) Build con Vite                                       โ
โ       $ vite build                                         โ
โ       โโ Bundling de assets                                โ
โ       โโ Minificaciรณn                                      โ
โ       โโ Tree shaking                                      โ
โ       โโ Sourcemaps para debugging                         โ
โ       โโ ~2 minutos                                        โ
โ                                                            โ
โ    d) Optimizaciones Vercel                                โ
โ       โโ Image optimization                                โ
โ       โโ Font optimization                                 โ
โ       โโ CSS minification                                  โ
โ       โโ JS compression (gzip/brotli)                      โ
โ                                                            โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 5. VERIFICACIรN DE BUILD                                   โ
โ    โโ โ Build exitoso                                     โ
โ    โโ โ Build fallido (ver logs)                          โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
          โโโโโโโโโดโโโโโโโโ
          โ               โ
        โ                โ
          โ               โ
          โ               โ
    โโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ
    โ 6. TEST  โ    โ BUILD FALLIDO    โ
    โ PREVIEW  โ    โ Notificar dev    โ
    โโโโโโฌโโโโโโ    โ Rol back a main  โ
         โ          โโโโโโโโโโโโโโโโโโโโ
         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 7. PREVIEW DEPLOYMENT                                      โ
โ    โโ URL temporal: https://xxxxx-projectname.vercel.app  โ
โ    โโ Disponible por 72 horas                              โ
โ    โโ Ideal para testing antes de merge                    โ
โ    โโ Acceso compartido con team                           โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 8. CODE REVIEW EN GITHUB                                   โ
โ    โโ Crear Pull Request                                   โ
โ    โโ Revisar cambios                                      โ
โ    โโ Vercel comenta en PR con link a preview              โ
โ    โโ Testing en ambiente igual a producciรณn               โ
โ    โโ [Approve & Merge to main]                            โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 9. MERGE A MAIN                                            โ
โ    โโ Merge PR                                             โ
โ    โโ GitHub envรญa webhook a Vercel                        โ
โ    โโ Vercel detecta cambios en master                     โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 10. PRODUCTION DEPLOYMENT                                  โ
โ    โโ Build (mismos pasos que preview)                     โ
โ    โโ Tests de deploy                                      โ
โ    โโ Validar connectivity                                 โ
โ    โโ Deploying to CDN global...                           โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 11. CDN GLOBAL DISTRIBUTION                                โ
โ    โโ Estados Unidos (East/West)                           โ
โ    โโ Europa (Frankfurt, London)                           โ
โ    โโ Asia (Singapore, Tokyo)                              โ
โ    โโ LATAM (Sรฃo Paulo)                                    โ
โ    โโ Replicaciรณn: ~30 segundos                            โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 12. VERIFICACIรN POST-DEPLOY                               โ
โ    โโ Health checks                                        โ
โ    โโ Conectividad a Supabase                              โ
โ    โโ Variables de entorno                                 โ
โ    โโ SSL certificate valid                                โ
โ    โโ Staging URLs funcionales                             โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 13. LANZAMIENTO EN VIVO                                    โ
โ    โโ URL principal: https://tasador-web.vercel.app       โ
โ    โโ Dominio custom: https://tasador.midominio.es        โ
โ    โโ Edge caching activado                                โ
โ    โโ Availability: 99.99%                                 โ
โ    โโ SSL/TLS automรกtico                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Configuraciรณn de Vercel

### archivo: vercel.json

```json
{
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "env": {
    "VITE_SUPABASE_URL": "@supabase_url",
    "VITE_SUPABASE_ANON_KEY": "@supabase_anon_key"
  },
  "functions": {
    "api/**": {
      "maxDuration": 30,
      "memory": 512
    }
  },
  "headers": [
    {
      "source": "/api/(.*)",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "no-cache"
        }
      ]
    }
  ],
  "redirects": [],
  "rewrites": [
    {
      "source": "/api/:path*",
      "destination": "https://api.supabase.co/:path*"
    }
  ]
}
```

### package.json - Scripts de Build

```json
{
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview",
    "test": "vitest",
    "test:ui": "vitest --ui"
  }
}
```

**Explicaciรณn:**
- `npm run build`: 
  1. Compila TypeScript: `tsc -b` 
  2. Build con Vite: `vite build`
- Vite genera carpeta `dist/` con archivos optimizados
- Vercel sirve contenido estรกtico desde `dist/`

### Estructura de Directorios para Deploy

```
tasador-web/
โโโ dist/                    โ Generado por Vite (output)
โ   โโโ index.html
โ   โโโ assets/
โ   โ   โโโ app-xxxxx.js
โ   โ   โโโ styles-xxxxx.css
โ   โโโ vite.svg
โ
โโโ src/                     โ Cรณdigo fuente
โ   โโโ main.tsx
โ   โโโ App.tsx
โ   โโโ components/
โ   โโโ lib/
โ   โโโ hooks/
โ   โโโ contexts/
โ   โโโ ...
โ
โโโ api/                     โ Edge Functions (opcional)
โ   โโโ admin/
โ   โ   โโโ delete-user.ts
โ   โ   โโโ wipe-password.ts
โ   โโโ ...
โ
โโโ public/                  โ Assets estรกticos
โ   โโโ interest-rates.json
โ
โโโ vercel.json              โ Configuraciรณn Vercel
โโโ package.json
โโโ tsconfig.json
โโโ vite.config.ts
โโโ tailwind.config.js
โโโ ...
```

## Variables de Entorno en Vercel

### Configurar Environment Variables

#### 1. En Vercel Dashboard

```
Proyecto โ Settings โ Environment Variables

Agregar:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ VITE_SUPABASE_URL                        โ
โ https://xxxxxx.supabase.co               โ
โ                                          โ
โ [Save]                                   โ
โ                                          โ
โ VITE_SUPABASE_ANON_KEY                   โ
โ ey.... (clave de 40+ caracteres)         โ
โ                                          โ
โ [Save]                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### 2. Ambientes diferentes

```
Production (main):
โโ VITE_SUPABASE_URL = https://xxxxx.supabase.co
โโ VITE_SUPABASE_ANON_KEY = eyJhbGc...

Preview (feature branches):
โโ VITE_SUPABASE_URL = https://xxxxx-staging.supabase.co
โโ VITE_SUPABASE_ANON_KEY = eyJhbGc... (staging key)

Development (local):
โโ .env.local
โโ VITE_SUPABASE_URL = http://localhost:54321
โโ VITE_SUPABASE_ANON_KEY = eyJhbGc...
```

### .env.example

```env
# Supabase Configuration
VITE_SUPABASE_URL=https://xxxxx.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Vercel Analytics (opcional)
NEXT_PUBLIC_VERCEL_ANALYTICS_ID=xxxxxx

# Speed Insights (opcional)
VERCEL_SPEED_INSIGHTS_ID=xxxxxx
```

## Conexiรณn Vercel โ Supabase

### Flujo de Autenticaciรณn

```
โโโโโโโโโโโโโโโโ
โ   Cliente    โ
โ  (Browser)   โ
โโโโโโโโฌโโโโโโโโ
       โ
       โ 1. Usuario login
       โ    email + password
       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Vercel (tasador-web.vercel.app) โ
โ  - React App                      โ
โ  - Supabase JS Client             โ
โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
           โ
           โ 2. Conecta a Supabase
           โ    VITE_SUPABASE_URL
           โ
           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Supabase API                     โ
โ  (xxxxxx.supabase.co)             โ
โ  - Valida credenciales            โ
โ  - Genera JWT token               โ
โ  - Retorna token + session        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
           โ
           โ 3. JWT Token
           โ
           โโ Header: Authorization: Bearer eyJhbGc...
           โ
           โโ Vรกlido por: 1 hora
              Refresh: 7 dรญas
```

## Build Optimization

### 1. Tree Shaking

```typescript
// Sร funciona (default export)
export default function App() { ... }
// Importado: import App from './App'
// Si no se usa: se elimina del bundle

// Sร funciona (named export)
export function utilizarTasaciones() { ... }
// Si no se usa: se elimina del bundle

// NO funciona (side effects)
import './styles.css' // Se mantiene
```

### 2. Code Splitting

```typescript
// Vite detecta lazy imports automรกticamente
const AdminPanel = lazy(() => import('./components/AdminPanel'))
const InterestCalc = lazy(() => import('./components/InterestCalculatorAdvanced'))

// Genera chunks separados:
// - admin-panel-xxx.js (descargado cuando se necesita)
// - interest-calc-xxx.js (descargado cuando se necesita)
```

### 3. Asset Optimization

```
Entrada:
โโ 1200+ lineas CSS โ minificadas โ 45KB gzip
โโ 8000+ lineas JS โ bundled + minified โ 180KB gzip
โโ Imรกgenes PNG โ webp โ 40% mรกs pequeรฑo

Resultado:
โโ Total inicial: 250KB
โโ Total gzip: 65KB (74% compresiรณn)
โโ Carga en 1.2s (red 4G)
```

## Monitoreo y Logs

### Acceder a Logs

#### 1. Vercel Dashboard

```
Proyecto โ Deployments

รltima versiรณn โ Logs

Ver:
โโ Build logs (compilaciรณn)
โโ Edge Function logs
โโ Runtime logs
โโ Errores de deploy
```

#### 2. Logs de Build

```
BUILD COMMAND:
npm run build

OUTPUT:
โ 48 modules transformed

dist/index.html                 0.45 kB
dist/assets/app-xxx.js       185.32 kB / gzip: 62.45 kB
dist/assets/styles-xxx.css     12.54 kB / gzip: 3.21 kB

Build complete: 2m 15s
```

#### 3. Logs de Runtime

```
Acceder a: https://tasador-web.vercel.app/
Check: Network tab en DevTools

Mรฉtrica clave:
โโ First Contentful Paint: 1.2s
โโ Largest Contentful Paint: 2.1s
โโ Cumulative Layout Shift: 0.08
โโ Time to Interactive: 2.8s
```

## Rollback (Volver a Versiรณn Anterior)

### Si Deploy Fallido

```
1. En Vercel Dashboard โ Deployments

2. Ver lista de deploys recientes
   โโ รltima (fallido)
   โโ Anterior (exitoso) โ
   โโ Anterior-2

3. Click en deploy anterior exitoso

4. Botรณn: "Redeploy"
   โโ Vuelve a deployar esa versiรณn

5. Vercel regenera automรกticamente
   โโ URL vuelve a versiรณn anterior
```

### Si Hay Bugs en Producciรณn

```
Opciรณn 1: Rollback rรกpido (arriba)
โโ Tiempo: 3-5 minutos
โโ Vuelve a versiรณn conocida

Opciรณn 2: Fix & Redeploy
โโ Corregir bug en cรณdigo
โโ Commit & push a main
โโ Vercel auto-deploya
โโ Tiempo: 5-7 minutos
```

## Casos de Uso Comunes

### Caso 1: Desplegar Feature Nueva

```
1. Crear rama feature
   $ git checkout -b feature/nueva-calculadora

2. Hacer cambios y commits
   $ git add .
   $ git commit -m "Feat: aรฑadir calculadora de intereses"

3. Push a rama
   $ git push origin feature/nueva-calculadora

4. Vercel automรกticamente:
   โโ Build preview deployment
   โโ URL: https://xxxxx-feature-xxxxx.vercel.app
   โโ Comentario en GitHub con link

5. Testear en preview

6. Crear Pull Request en GitHub

7. Merge a main โ Deploy a producciรณn
```

### Caso 2: Hotfix de Bug en Producciรณn

```
1. Clonar latest main
   $ git pull origin main

2. Crear rama hotfix
   $ git checkout -b hotfix/bug-critico

3. Arreglar bug
   $ # editar archivos

4. Commit y push
   $ git add .
   $ git commit -m "Fix: corregir cรกlculo de IVA"
   $ git push origin hotfix/bug-critico

5. Crear PR desde hotfix โ main

6. Review rรกpido

7. Merge a main โ Auto deploy a producciรณn
```

### Caso 3: Actualizar Variables de Entorno

```
Escenario: Nueva clave de Supabase

1. En Supabase:
   โโ Generar nueva API key
   โโ Copiar clave

2. En Vercel Dashboard:
   โโ Settings โ Environment Variables
   โโ Editar: VITE_SUPABASE_ANON_KEY
   โโ Pegar nuevo valor
   โโ [Save]

3. Vercel detecta cambio:
   โโ Marca todos los deploys como obsoletos
   โโ Redeploy automรกtico de main
   โโ Nuevo env var disponible en 1-2 minutos
```

## Troubleshooting

### Build Fallido: "TypeScript compilation failed"

```
Error: src/components/AdminPanel.tsx (25,10): 
       Property 'email' does not exist on type 'User'

Soluciรณn:
1. Revisar tipos en interfaces
2. Ejecutar localmente: npm run build
3. Fijar tipos faltantes
4. Commit y push
```

### Build Fallido: "Module not found"

```
Error: Cannot find module '@/lib/supabase'

Soluciรณn:
1. Verificar import es correcto
2. Comprobar alias en tsconfig.json
   "paths": {
     "@/*": ["./src/*"]
   }
3. Verificar archivo existe
4. Reexecute build
```

### Deploy Lento (>10 minutos)

```
Posibles causas:
โโ Instalaciรณn lenta de npm
โโ Build de assets pesados
โโ Timeout de Supabase
โโ Fila de deploys en Vercel

Optimizaciones:
โโ Usar npm ci en lugar de npm install
โโ Reducir tamaรฑo de dependencias
โโ Lazy load componentes grandes
โโ Esperar si hay fila
```

### App No Carga en Vercel

```
Verificar:
1. URL correcta: https://tasador-web.vercel.app/
2. Status en Vercel: Ready?
3. Network tab:
   โโ index.html โ 200?
   โโ app-xxx.js โ 200?
   โโ styles-xxx.css โ 200?
4. Console errors?
5. Conecta a Supabase?
   โโ Check VITE_SUPABASE_URL en Network
6. CORS issues?
```

### Variables de Entorno No Funcionan

```
Problema: app.env.VITE_SUPABASE_URL undefined

Verificar:
1. En Vercel: Settings โ Environment Variables
   โโ ยฟVariable existe?
2. Nombre correcto: VITE_SUPABASE_URL (case-sensitive)
3. En cรณdigo: import.meta.env.VITE_SUPABASE_URL
4. Redeploy despuรฉs de agregar variables
5. Hard refresh del navegador
```

## Performance Tips

```typescript
// โ BUENO: Lazy load componentes grandes
const AdminPanel = lazy(() => import('./components/AdminPanel'))

// โ BUENO: Code splitting por ruta
const routes = [
  { path: '/', element: <CalculatorContainer /> },
  { path: '/admin', element: <lazy_load_admin /> }
]

// โ BUENO: Cache headers en static assets
// vercel.json configura por defecto 1 aรฑo

// โ MALO: Importar archivos enormes globalmente
import hugeLibrary from 'huge-lib' // En el top level

// โ MALO: Mรบltiples llamadas a API en paralelo sin lรญmites
```

## Resumen del Workflow

```
Local Development
    โ
$ git push origin feature-branch
    โ
Vercel Preview Deploy (automรกtico)
    โ
Test en https://xxxx-preview.vercel.app
    โ
GitHub Pull Request + Code Review
    โ
$ git merge
    โ
Vercel Production Deploy (automรกtico a main)
    โ
Live en https://tasador-web.vercel.app โ
```

## Referencias รtiles

- **Vercel Dashboard**: https://vercel.com/dashboard
- **Build Logs**: https://vercel.com/projects
- **Environment Docs**: https://vercel.com/docs/environment-variables
- **Troubleshooting**: https://vercel.com/docs/error-codes
