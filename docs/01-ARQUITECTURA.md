# ๐๏ธ Diagrama de Arquitectura - Tasador Web

## Visiรณn General de la Arquitectura

Tasador Web es una aplicaciรณn web moderna construida con una arquitectura de tres capas: presentaciรณn, negocio y datos.

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         CLIENTE (Frontend)                          โ
โ                                                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  React 19 + TypeScript + Vite                               โ  โ
โ  โ  - App.tsx (Router principal)                               โ  โ
โ  โ  - Contexto de Autenticaciรณn                                โ  โ
โ  โ  - Componentes UI React                                     โ  โ
โ  โ  - Hooks personalizados                                     โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                              โ                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  Capas de Lรณgica (src/lib)                                  โ  โ
โ  โ  - calculator.ts: Cรกlculo de costas                         โ  โ
โ  โ  - interestCalculator.ts: Cรกlculo de intereses              โ  โ
โ  โ  - municipios.ts: Gestiรณn de municipios                     โ  โ
โ  โ  - entidades.ts: Gestiรณn de entidades                       โ  โ
โ  โ  - docx-generator.ts: Generaciรณn de documentos              โ  โ
โ  โ  - database-init.ts: Inicializaciรณn de BD                   โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                              โ                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  Servicios (Supabase Client JS)                             โ  โ
โ  โ  - supabase.ts: Cliente Supabase configurado                โ  โ
โ  โ  - Autenticaciรณn JWT                                        โ  โ
โ  โ  - REST API Client                                          โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โ HTTPS
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     BACKEND (Supabase)                              โ
โ                                                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  API REST (PostgREST)                                        โ  โ
โ  โ  - Endpoints automรกticos para todas las tablas               โ  โ
โ  โ  - Autenticaciรณn JWT                                        โ  โ
โ  โ  - RLS (Row Level Security) por usuario                      โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                              โ                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  Autenticaciรณn & Autorizaciรณn                               โ  โ
โ  โ  - Supabase Auth (JWT tokens)                                โ  โ
โ  โ  - Row Level Security (RLS)                                  โ  โ
โ  โ  - Gestiรณn de sesiones                                       โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                              โ                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  Base de Datos (PostgreSQL)                                 โ  โ
โ  โ                                                              โ  โ
โ  โ  Tablas:                                                     โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ  โ usuarios_personalizados                             โ   โ  โ
โ  โ  โ - id, email, nombre, rol, created_at                โ   โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ                                                              โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ  โ tasaciones                                          โ   โ  โ
โ  โ  โ - id, user_id, cliente, procedimiento, municipio   โ   โ  โ
โ  โ  โ - costas, iva, total, created_at, updated_at       โ   โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ                                                              โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ  โ entidades                                           โ   โ  โ
โ  โ  โ - id, codigo, nombre_corto, nombre_completo        โ   โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ                                                              โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ  โ municipios_ica                                      โ   โ  โ
โ  โ  โ - id, codigo_postal, municipio, criterio_ica        โ   โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ                                                              โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ  โ costas_x_ica                                        โ   โ  โ
โ  โ  โ - id, criterio_ica, fase, instancia, costas        โ   โ  โ
โ  โ  โ - iva, total, created_at                           โ   โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ                                                              โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ  โ intereses_legales                                   โ   โ  โ
โ  โ  โ - id, tipo_interes, porcentaje, fecha_vigencia     โ   โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ                                                              โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ  โ formulas_calculo                                    โ   โ  โ
โ  โ  โ - id, nombre, descripcion, formula, activa          โ   โ  โ
โ  โ  โ - created_at, updated_at                            โ   โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ                                                              โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ  โ baremos_honorarios                                  โ   โ  โ
โ  โ  โ - id, cantidad_minima, cantidad_maxima              โ   โ  โ
โ  โ  โ - porcentaje, honorarios_minimos                    โ   โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ                                                              โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ  โ word_template_settings                              โ   โ  โ
โ  โ  โ - id, user_id, template_config, created_at          โ   โ  โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ  โ
โ  โ                                                              โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  Edge Functions (Serverless)                                 โ  โ
โ  โ  - Funciones TypeScript personalizadas                        โ  โ
โ  โ  - Ejecutadas en Deno Runtime                                 โ  โ
โ  โ  - Lรณgica compleja del servidor                               โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    SERVICIOS EXTERNOS                               โ
โ                                                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  Vercel                                                      โ  โ
โ  โ  - Hosting & CI/CD                                           โ  โ
โ  โ  - GitHub Integration                                        โ  โ
โ  โ  - Automatic Deployments                                     โ  โ
โ  โ  - Preview Deployments                                       โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  GitHub                                                      โ  โ
โ  โ  - Control de versiones                                      โ  โ
โ  โ  - Repositorio principal                                     โ  โ
โ  โ  - Git workflows                                             โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Flujo de Datos Principales

### 1. Autenticaciรณn de Usuario

```
Usuario
    โ
[Componente Login]
    โ
[CustomAuthContext - useAuth()]
    โ
[Supabase Auth.signInWithPassword()]
    โ
[JWT Token]
    โ
[LocalStorage + Cookie]
    โ
[Contexto compartido en app]
```

### 2. Cรกlculo de Tasaciรณn

```
[TasacionForm] (Usuario completa formulario)
    โ
[validate - Zod Schema]
    โ
[useTasaciones Hook]
    โ
[calcularCostas()] - src/lib/calculator.ts
    โ
    โโ Buscar municipio โ obtener criterio ICA
    โ
    โโ Consultar tabla costas_x_ica
    โ    (criterio_ica, fase, instancia)
    โ
    โโ Aplicar fรณrmula de cรกlculo
    โ
    โโ Calcular IVA (21%)
    โ
[Supabase - Insertar en tabla 'tasaciones']
    โ
[Actualizar historial - HistorialTasaciones]
```

### 3. Cรกlculo de Intereses

```
[InterestCalculatorAdvanced] (Usuario ingresa datos)
    โ
[Validaciรณn de formulario]
    โ
[interestCalculator.ts]
    โ
    โโ Capital inicial
    โโ Tasa de interรฉs (desde BD o manual)
    โโ Dรญas de demora
    โโ Fรณrmula: Interรฉs = Capital ร Tasa ร Dรญas / 36500
    โ
    โโ Cรกlculo de IVA sobre intereses
    โ
[Mostrar resultados animados]
    โ
[Opciรณn: Guardar / Exportar PDF]
```

### 4. Generaciรณn de Documentos Word

```
[TasacionForm - Botรณn "Generar Minuta"]
    โ
[docx-generator.ts - generateMinutaDocx()]
    โ
[Supabase - Obtener datos tasaciรณn]
    โ
[DOCX library]
    โ
    โโ Plantilla base
    โโ Reemplazar campos dinรกmicos
    โโ Insertar tablas
    โโ Insertar grรกficos
    โ
    โโ Formateo profesional
    โ
[Descargar archivo .docx]
```

## Patrones y Tecnologรญas Clave

### Patrones de React
- **Hooks**: `useState`, `useEffect`, `useContext`, `useForm` (react-hook-form)
- **Context API**: Autenticaciรณn centralizada
- **Custom Hooks**: `useTasaciones`, `useBaremosHonorarios`, `useFormulasCalculo`, etc.

### Validaciรณn
- **Zod**: Validaciรณn de esquemas TypeScript
- **React Hook Form**: Gestiรณn de formularios

### Estilo
- **Tailwind CSS**: Utilidades CSS
- **Lucide React**: Iconos SVG
- **Framer Motion**: Animaciones

### Exportaciรณn de Datos
- **DOCX**: Generaciรณn de documentos Word
- **PDF**: Exportaciรณn con jsPDF
- **Excel**: Lectura/escritura con xlsx

### Seguridad
- **Row Level Security (RLS)**: Polรญticas de Supabase por usuario
- **JWT Tokens**: Autenticaciรณn sin estado
- **CORS**: Control de acceso entre dominios
- **HTTPS**: Encriptaciรณn en trรกnsito

## Componentes Principales

### Nivel de Presentaciรณn (src/components)
- `AdminPanel`: Panel de administraciรณn
- `TasacionForm`: Formulario principal de tasaciรณn
- `InterestCalculatorAdvanced`: Calculadora de intereses
- `HistorialTasaciones`: Historial de tasaciones
- `Login`: Componente de autenticaciรณn
- `CalculatorContainer`: Contenedor principal
- `TasacionesTable`: Tabla de tasaciones
- `EntidadesTable`: Gestiรณn de entidades
- `MunicipioICATable`: Gestiรณn de municipios ICA

### Nivel de Negocio (src/lib)
- `calculator.ts`: Lรณgica de cรกlculo de costas
- `interestCalculator.ts`: Lรณgica de cรกlculo de intereses
- `municipios.ts`: Funciones de municipios
- `entidades.ts`: Funciones de entidades
- `docx-generator.ts`: Generaciรณn de documentos

### Nivel de Datos (src/lib)
- `supabase.ts`: Cliente Supabase
- `database-init.ts`: Inicializaciรณn de BD
- Hooks en `src/hooks/*`: Consultas a BD

## Despliegue

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Git commit a master en GitHub          โ
โโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
                   โ
                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Webhook de GitHub โ Vercel             โ
โโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
                   โ
                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Build & Optimizaciรณn Vercel            โ
โ  - npm run build                        โ
โ  - TypeScript compilation               โ
โ  - Vite bundling                        โ
โ  - Asset optimization                   โ
โโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
                   โ
                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Deploy a CDN Global Vercel             โ
โ  - Edge caching                         โ
โ  - Geografic distribution               โ
โ  - SSL automรกtico                       โ
โโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
                   โ
                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  https://tasador-web.vercel.app/        โ
โ  [Listo para producciรณn]                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Variables de Entorno

```env
VITE_SUPABASE_URL=https://xxxxx.supabase.co
VITE_SUPABASE_ANON_KEY=xxxxxx_anonkey_xxxxxx
```

## Notas de Seguridad

1. **RLS Policies**: Cada usuario solo ve sus propias tasaciones
2. **JWT Auth**: Tokens con expiraciรณn automรกtica
3. **No datos sensibles en cliente**: Contraseรฑas y datos crรญticos en servidor
4. **CORS habilitado**: Solo dominios autorizados
5. **Validaciรณn en cliente y servidor**: Validaciรณn doble de datos
